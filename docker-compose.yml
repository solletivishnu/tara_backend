services:
  backend:
    image: ${DOCKER_IMAGE}:${IMAGE_TAG}
    container_name: tara_backend_prod_${DEPLOY_SLOT}
    healthcheck:
      test: curl -f http://localhost:8000/user_management/happy-coder/ || exit 1
      interval: 10s
      timeout: 3s
      retries: 5

    restart: always
    ports:
      - "${BACKEND_PORT}:8000"
    env_file:
      - .env
    volumes:
      - backend_logs:/app/logs
    command: >
      gunicorn Tara.wsgi:application
      --bind 0.0.0.0:8000
      --workers 2
      --access-logfile /app/logs/access.log
      --error-logfile /app/logs/error.log
    networks:
      - taranet

  celery_worker:
    image: ${DOCKER_IMAGE}:${IMAGE_TAG}
    container_name: celery_worker_${DEPLOY_SLOT}
    command: celery -A Tara worker --loglevel=info --pool=solo
    restart: always
    environment:
      - PYTHONPATH=/app
      - DJANGO_SETTINGS_MODULE=Tara.settings.default
    env_file:
      - .env
    networks:
      - taranet

  celery_beat:
    image: ${DOCKER_IMAGE}:${IMAGE_TAG}
    container_name: celery_beat_${DEPLOY_SLOT}
    command: celery -A Tara beat --loglevel=info
    restart: always
    environment:
      - PYTHONPATH=/app
      - DJANGO_SETTINGS_MODULE=Tara.settings.default
    env_file:
      - .env
    networks:
      - taranet

volumes:
  backend_logs:

networks:
  taranet:
    external: true
    name: taranet
